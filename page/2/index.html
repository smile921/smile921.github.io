<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Smile921" />


    
    


<meta name="description" content="关注网络安全动态，追求心中的向往。迈入新世界，培养独当一面的 Web 前端工程师！坚持努力，希望将来的某天也能掌握Haskell，虽然多次学习均不得其道。">
<meta property="og:type" content="website">
<meta property="og:title" content="关注网络安全动态，追求心中的向往">
<meta property="og:url" content="http://smile921.github.io/page/2/index.html">
<meta property="og:site_name" content="关注网络安全动态，追求心中的向往">
<meta property="og:description" content="关注网络安全动态，追求心中的向往。迈入新世界，培养独当一面的 Web 前端工程师！坚持努力，希望将来的某天也能掌握Haskell，虽然多次学习均不得其道。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="关注网络安全动态，追求心中的向往">
<meta name="twitter:description" content="关注网络安全动态，追求心中的向往。迈入新世界，培养独当一面的 Web 前端工程师！坚持努力，希望将来的某天也能掌握Haskell，虽然多次学习均不得其道。">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="关注网络安全动态，追求心中的向往" type="application/atom+xml">



    <link rel="shortcut icon" href="/img/favicon.ico">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">


    <style> .article { opacity: 0;} </style>


<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>关注网络安全动态，追求心中的向往</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/timg.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Smile921</a></h1>
        </hgroup>

        
        <p class="header-subtitle">迈入新世界，培养独当一面的 Web 前端工程师！</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/.">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/security">随笔</a></li>
                        
                            <li><a href="/archives/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:ruby2010ruby@163.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/smile921" title="GitHub"></a>
                            
                                <a class="fa V2EX" href="http://www.v2ex.com/member/lanyi921" title="V2EX"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/IM/">IM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KaTeX/">KaTeX</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TeX/">TeX</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/api/">api</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awesome/">awesome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blockchain/">blockchain</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bt/">bt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/devdoc/">devdoc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dht/">dht</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/electron/">electron</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/emacs/">emacs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/forum/">forum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fun/">fun</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitlab/">gitlab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/haskell/">haskell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hello/">hello</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jpda/">jpda</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/koan/">koan</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/koans/">koans</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lua/">lua</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongo/">mongo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/">mongodb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/note/">note</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/office/">office</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oracle/">oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ruby/">ruby</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/science/">science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/">security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spcaemacs/">spcaemacs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/telegram/">telegram</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/test/">test</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/truffle/">truffle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tutor/">tutor</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/waf/">waf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web3j/">web3j</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/存储过程/">存储过程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/笔记/">笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/题解/">题解</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于前端</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Smile921</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/timg.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Smile921</a></h1>
            </hgroup>
            
            <p class="header-subtitle">迈入新世界，培养独当一面的 Web 前端工程师！</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/.">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/security">随笔</a></li>
                
                    <li><a href="/archives/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:ruby2010ruby@163.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/smile921" title="GitHub"></a>
                            
                                <a class="fa V2EX" target="_blank" href="http://www.v2ex.com/member/lanyi921" title="V2EX"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-oracle-存储过程解题示例一" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/201608oracle-存储过程解题示例一/" class="article-date">
      <time datetime="2016-08-22T08:09:16.000Z" itemprop="datePublished">2016-08-22</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/201608oracle-存储过程解题示例一/">oracle 存储过程解题示例一</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="问题概述"><a href="#问题概述" class="headerlink" title="问题概述"></a>问题概述</h2><p> 某一个报表数据来自一个复杂业务的查询，其中某类资产的数据需要按百分比展示。同时这类资产的百分比总和加起来应该是100% 。问题比如这个分类是2,2,2 百分比是0.33,0.33,0.33 最终给出的结果是需要修正的即走后一条数据应该修正为0.34；同理的 如果是 1,2,3,1 的百分比计算也需要修正最后一条数据。当时的业务场景下只能用存储过程</p>
<h2 id="问题简化解析"><a href="#问题简化解析" class="headerlink" title="问题简化解析"></a>问题简化解析</h2><p> 首先加一些简单的测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">-- Create table</div><div class="line">create table OOTEST</div><div class="line">(</div><div class="line">  id     NVARCHAR2(16),</div><div class="line">  types  NVARCHAR2(16),</div><div class="line">  shares NUMBER</div><div class="line">)</div><div class="line">insert into ootest (ID, TYPES, SHARES)</div><div class="line">values (&apos;1&apos;, &apos;aa&apos;, 1);</div><div class="line"></div><div class="line">insert into ootest (ID, TYPES, SHARES)</div><div class="line">values (&apos;2&apos;, &apos;aa&apos;, 1);</div><div class="line"></div><div class="line">insert into ootest (ID, TYPES, SHARES)</div><div class="line">values (&apos;3&apos;, &apos;aa&apos;, 1);</div><div class="line"></div><div class="line">insert into ootest (ID, TYPES, SHARES)</div><div class="line">values (&apos;4&apos;, &apos;bb&apos;, 1);</div><div class="line"></div><div class="line">insert into ootest (ID, TYPES, SHARES)</div><div class="line">values (&apos;5&apos;, &apos;bb&apos;, 2);</div><div class="line"> select t.id,t.types,t.shares, rowid from ootest t ;</div></pre></td></tr></table></figure></p>
<p> eg：<br>| ID            | TYPES         | SHARES  |<br>| ————- |:————-:| ——-:|<br>| 1             | aa            |       1 |<br>| 2             | aa            |       1 |<br>| 3             | aa            |       1 |<br>| 4             | bb            |       1 |<br>| 5             | bb            |       2 |</p>
<h2 id="存储过程实现-Version-1-0"><a href="#存储过程实现-Version-1-0" class="headerlink" title="存储过程实现 (Version 1.0)"></a>存储过程实现 (Version 1.0)</h2><p>初步想法需要搞个临时表，先筛选数据进去，再遍历修改，之后再查询临时表返回数据即可。为了简单实现这里就不用临时表了，直接查询，然后循环处理数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">---</div><div class="line">--  </div><div class="line">-- 当过程中含有输出参数时，调用时必须通过BEGIN  END块，不能通过EXEC或CALL调用。如：</div><div class="line">DECLARE</div><div class="line">retcode NUMBER(7,2);</div><div class="line">retnote varchar(4000);</div><div class="line">BEGIN</div><div class="line">queryPercentOne(retcode,retnote,&apos;aa&apos;);</div><div class="line">DBMS_OUTPUT.PUT_LINE(retcode);</div><div class="line">DBMS_OUTPUT.PUT_LINE(retnote);</div><div class="line">END;</div><div class="line">---</div><div class="line">*/</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">create or replace procedure queryPercentOne(o_code out int, o_msg out varchar2,v_types in varchar2) is</div><div class="line">    v_count           number := 0; -- 总记录数</div><div class="line">    v_total           number := 0; </div><div class="line">    v_last            number := 0;</div><div class="line">    v_last_per        number :=0;</div><div class="line">    v_cid             NVARCHAR2(16);</div><div class="line">    v_ctypes          NVARCHAR2(16);</div><div class="line">    v_cshares         number;</div><div class="line">    v_rownum          number :=0;</div><div class="line">    v_cpercent        number(3,2) :=0.0;</div><div class="line">    v_percent         number(3,2) :=0.0;</div><div class="line">    v_crownum          number :=1;</div><div class="line">    CURSOR cur IS SELECT t.* FROM ootest t where t.types= v_types;</div><div class="line">begin</div><div class="line">   begin </div><div class="line">    select count(*) into v_count  from ootest t where t.types= v_types;  </div><div class="line">    select sum(t.shares) into v_total  from ootest t where t.types= v_types;</div><div class="line">   EXCEPTION    WHEN NO_DATA_FOUND THEN</div><div class="line">     v_count :=0;</div><div class="line">     v_total :=0;</div><div class="line">   end ;</div><div class="line">   open cur;</div><div class="line">   LOOP</div><div class="line">       fetch cur into  v_cid,v_ctypes,v_cshares ;</div><div class="line">       exit when cur%notfound;</div><div class="line">       v_cpercent := v_cshares/v_total;</div><div class="line">       if v_crownum = v_count then</div><div class="line">         v_cshares := v_total; </div><div class="line">         v_cpercent := (1 - v_percent);</div><div class="line">       else </div><div class="line">         v_percent := v_percent + (v_cshares/v_total);</div><div class="line">       end if ;     </div><div class="line">       dbms_output.put_line(v_crownum||&apos; . &apos;||v_cid||&apos; . &apos;||v_ctypes||&apos; . &apos;||v_cshares||&apos; .&apos;|| to_char(v_cpercent,&apos;0.99&apos;));</div><div class="line">       v_crownum := v_crownum+1;</div><div class="line">   end LOOP;   </div><div class="line">  o_code :=-1;</div><div class="line">  o_msg :=&apos;nothing&apos;;</div><div class="line">end queryPercentOne;</div></pre></td></tr></table></figure>
<h2 id="测试存储过程"><a href="#测试存储过程" class="headerlink" title="测试存储过程"></a>测试存储过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">begin</div><div class="line">  -- Call the procedure</div><div class="line">  querypercentone(o_code =&gt; :o_code,</div><div class="line">                  o_msg =&gt; :o_msg,</div><div class="line">                  v_types =&gt; :v_types);</div><div class="line">end;</div></pre></td></tr></table></figure>
<h3 id="测试-aa"><a href="#测试-aa" class="headerlink" title="测试 aa"></a>测试 aa</h3><blockquote>
<p>1 . 1 . aa . 1 . 0.33<br>2 . 2 . aa . 1 . 0.33<br>3 . 3 . aa . 3 . 0.34</p>
</blockquote>
<h3 id="测试-bb"><a href="#测试-bb" class="headerlink" title="测试 bb"></a>测试 bb</h3><blockquote>
<p>1 . 4 . bb . 1 . 0.33<br>2 . 5 . bb . 3 . 0.67</p>
</blockquote>
<h2 id="复杂SQL也可以做到-Version2-0"><a href="#复杂SQL也可以做到-Version2-0" class="headerlink" title="复杂SQL也可以做到 (Version2.0)"></a>复杂SQL也可以做到 (Version2.0)</h2><p>使用下列oracle自带函数</p>
<h3 id="ratio-to-report"><a href="#ratio-to-report" class="headerlink" title="ratio_to_report"></a>ratio_to_report</h3><blockquote>
<p>主要完成对百分比的计算，语法为<br>ratio_to_report(exp) over()<br>也就是根据over窗口函数的作用区间，求出作用区间中的单个值在整个区间的总值的比重<br>…</p>
</blockquote>
<h3 id="decode"><a href="#decode" class="headerlink" title="decode"></a>decode</h3><blockquote>
<p>decode(条件,值1,返回值1,值2,返回值2,…值n,返回值n,缺省值)</p>
<p>该函数的含义如下：<br>IF 条件=值1 THEN<br>　　　　RETURN(翻译值1)<br>ELSIF 条件=值2 THEN<br>　　　　RETURN(翻译值2)<br>　　　　……<br>ELSIF 条件=值n THEN<br>　　　　RETURN(翻译值n)<br>ELSE<br>　　　　RETURN(缺省值)<br>END IF</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">select d.id,</div><div class="line">       d.shares,</div><div class="line">       d.ratio,</div><div class="line">       d.cnt,</div><div class="line">       d.total,</div><div class="line">       decode(d.cnt, 1, d.tail_rt + d.rate, d.rate) rate,</div><div class="line">       d.tail_rt</div><div class="line">  from (select c.id,</div><div class="line">               c.shares,</div><div class="line">               c.ratio, -- 份额 </div><div class="line">               c.total,</div><div class="line">               round(c.ratio, 4) rate, --占比</div><div class="line">               1 - sum(round(c.ratio, 4)) over() tail_rt, --尾差</div><div class="line">               row_number() over(partition by c.types order by c.id) cnt</div><div class="line">          from (select t.id,</div><div class="line">                       t.shares,</div><div class="line">                       t.types,</div><div class="line">                       b.total,</div><div class="line">                       ratio_to_report((t.shares)) OVER(partition by t.types) ratio</div><div class="line">                  from ootest t</div><div class="line">                  left join((select t.types, sum(t.shares) total</div><div class="line">                              from ootest t</div><div class="line">                             group by t.types) b)</div><div class="line">                    on t.types = b.types</div><div class="line">                 where t.types = &apos;bb&apos;) c) d;</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oracle/">oracle</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/存储过程/">存储过程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/题解/">题解</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Android-开发最佳实践" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/201608Android-开发最佳实践/" class="article-date">
      <time datetime="2016-08-18T01:00:39.000Z" itemprop="datePublished">2016-08-18</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/201608Android-开发最佳实践/">Android 开发最佳实践</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h4 id="使用-Gradle-和他推荐的工程结构"><a href="#使用-Gradle-和他推荐的工程结构" class="headerlink" title="使用 Gradle 和他推荐的工程结构"></a>使用 Gradle 和他推荐的工程结构</h4><h4 id="把密码和敏感数据放在-gradle-properties-配置文件中"><a href="#把密码和敏感数据放在-gradle-properties-配置文件中" class="headerlink" title="把密码和敏感数据放在 gradle.properties 配置文件中"></a>把密码和敏感数据放在 gradle.properties 配置文件中</h4><h4 id="使用-Jackson-库解析-JSON-数据"><a href="#使用-Jackson-库解析-JSON-数据" class="headerlink" title="使用 Jackson 库解析 JSON 数据"></a>使用 Jackson 库解析 JSON 数据</h4><h4 id="不要自己实现-Http-client-使用-Volley-库或者-OkHttp-库"><a href="#不要自己实现-Http-client-使用-Volley-库或者-OkHttp-库" class="headerlink" title="不要自己实现 Http client 使用 Volley 库或者 OkHttp 库"></a>不要自己实现 Http client 使用 Volley 库或者 OkHttp 库</h4><h4 id="避免使用-Guava-库，由于-65k-方法限制使用其他少数库"><a href="#避免使用-Guava-库，由于-65k-方法限制使用其他少数库" class="headerlink" title="避免使用 Guava 库，由于 65k 方法限制使用其他少数库"></a>避免使用 Guava 库，由于 65k 方法限制使用其他少数库</h4><h4 id="在选择-Activities-和-Fragments-时特别小心"><a href="#在选择-Activities-和-Fragments-时特别小心" class="headerlink" title="在选择 Activities 和 Fragments 时特别小心"></a>在选择 Activities 和 Fragments 时特别小心</h4><h4 id="布局XML也是代码，请也好好组织编排"><a href="#布局XML也是代码，请也好好组织编排" class="headerlink" title="布局XML也是代码，请也好好组织编排"></a>布局XML也是代码，请也好好组织编排</h4><h4 id="使用样式避免布局的XML中有重复多余的属性"><a href="#使用样式避免布局的XML中有重复多余的属性" class="headerlink" title="使用样式避免布局的XML中有重复多余的属性"></a>使用样式避免布局的XML中有重复多余的属性</h4><h4 id="使用多个样式文件避免单个大文件样式"><a href="#使用多个样式文件避免单个大文件样式" class="headerlink" title="使用多个样式文件避免单个大文件样式"></a>使用多个样式文件避免单个大文件样式</h4><h4 id="保持你的颜色定义xml简短整洁，甚至定义一个调色板"><a href="#保持你的颜色定义xml简短整洁，甚至定义一个调色板" class="headerlink" title="保持你的颜色定义xml简短整洁，甚至定义一个调色板"></a>保持你的颜色定义xml简短整洁，甚至定义一个调色板</h4><h4 id="Do-not-make-a-deep-hierarchy-of-ViewGroups"><a href="#Do-not-make-a-deep-hierarchy-of-ViewGroups" class="headerlink" title="Do not make a deep hierarchy of ViewGroups"></a>Do not make a deep hierarchy of ViewGroups</h4><h4 id="避免客户端处理-WebViews-特别小心内存泄漏"><a href="#避免客户端处理-WebViews-特别小心内存泄漏" class="headerlink" title="避免客户端处理 WebViews 特别小心内存泄漏"></a>避免客户端处理 WebViews 特别小心内存泄漏</h4><h4 id="使用-Robolectric-做单元测试，Robotium-做UI-测试"><a href="#使用-Robolectric-做单元测试，Robotium-做UI-测试" class="headerlink" title="使用 Robolectric 做单元测试，Robotium 做UI 测试"></a>使用 Robolectric 做单元测试，Robotium 做UI 测试</h4><h4 id="使用-Genymotion-作为你的模拟器"><a href="#使用-Genymotion-作为你的模拟器" class="headerlink" title="使用 Genymotion 作为你的模拟器"></a>使用 Genymotion 作为你的模拟器</h4><h4 id="使用-ProGuard-或者-DexGuard"><a href="#使用-ProGuard-或者-DexGuard" class="headerlink" title="使用 ProGuard 或者 DexGuard"></a>使用 ProGuard 或者 DexGuard</h4><h4 id="使用-SharedPreferences-做简单的持久化，否则使用-ContentProviders"><a href="#使用-SharedPreferences-做简单的持久化，否则使用-ContentProviders" class="headerlink" title="使用 SharedPreferences 做简单的持久化，否则使用 ContentProviders"></a>使用 SharedPreferences 做简单的持久化，否则使用 ContentProviders</h4><h4 id="使用-Stetho-调试你的应用"><a href="#使用-Stetho-调试你的应用" class="headerlink" title="使用 Stetho 调试你的应用"></a>使用 Stetho 调试你的应用</h4><h2 id="Android-SDK"><a href="#Android-SDK" class="headerlink" title="Android SDK"></a>Android SDK</h2><p>把你的Android SDK 放到你的Home目录或者应用的独立目录，不要和IDE放在一起，避免某些原因IDE升级或者重装导致长时间的SDK重新下载安装。</p>
<h2 id="编译系统"><a href="#编译系统" class="headerlink" title="编译系统"></a>编译系统</h2><p>你的默认编译工具应该是 Gradle</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tutor/">tutor</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-java-jpda-远程调试" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/201608java-jpda-远程调试/" class="article-date">
      <time datetime="2016-08-17T05:30:12.000Z" itemprop="datePublished">2016-08-17</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/201608java-jpda-远程调试/">java jpda 远程调试</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="Java-Platform-Debugger-Architecture-JPDA-Java平台调试架构-由Java虚拟机后端和调试平台前端组成"><a href="#Java-Platform-Debugger-Architecture-JPDA-Java平台调试架构-由Java虚拟机后端和调试平台前端组成" class="headerlink" title="Java Platform Debugger Architecture(JPDA:Java平台调试架构) 由Java虚拟机后端和调试平台前端组成"></a>Java Platform Debugger Architecture(JPDA:Java平台调试架构) 由Java虚拟机后端和调试平台前端组成</h2><h2 id="对-执行java-或者java-jar-进行远程调试"><a href="#对-执行java-或者java-jar-进行远程调试" class="headerlink" title="对 执行java 或者java -jar 进行远程调试"></a>对 执行java 或者java -jar 进行远程调试</h2><h3 id="添加-agentlib-jdwp-transport-dt-socket-address-9000-server-y-suspend-n-即可"><a href="#添加-agentlib-jdwp-transport-dt-socket-address-9000-server-y-suspend-n-即可" class="headerlink" title="添加 -agentlib:jdwp=transport=dt_socket,address=9000,server=y,suspend=n  即可"></a>添加 -agentlib:jdwp=transport=dt_socket,address=9000,server=y,suspend=n  即可</h3><ul>
<li>注意一 transport=dt_socket 不可随意更改</li>
<li>注意二 address 是端口，不是ip地址或者host地址</li>
</ul>
<p>例子 java MainClass ,这里MainClass是要运行的class名字包括包名称</p>
<blockquote>
<p>“C:\Program Files\Java\jdk1.6.0_45\bin\java.exe” \<br>-agentlib:jdwp=transport=dt_socket,address=9000,server=y,suspend=n  \<br>-classpath .;”\E:\V1.0_ZJ\webmodel\otcp\cif\src\conf” \<br>“-Djava.ext.dirs=\E:\V1.0_ZJ\webmodel\otcp\cif\src\lib” MainClass<br>rem Listening for transport dt_socket at address: 9000<br>rem jpda program started</p>
</blockquote>
<h2 id="Tomcat-远程调试"><a href="#Tomcat-远程调试" class="headerlink" title="Tomcat  远程调试"></a>Tomcat  远程调试</h2><p>不改文件进行远程调试,可以通过命令”catalia.bat jpda start”，用调试状态启动tomcat，  </p>
<pre><code>
linux则是&quot;./catalia.sh jpda start&quot;。看catalia.bat 和 catalia.sh的区别,大致相同jpda参数是   

JPDA_TRANSPORT  (Optional) JPDA transport used when the &quot;jpda start&quot;   
                command is executed. The default is &quot;dt_socket&quot;.   

JPDA_ADDRESS    (Optional) Java runtime options used when the &quot;jpda start&quot;   
                command is executed. The default is 8000.   

JPDA_SUSPEND    (Optional) Java runtime options used when the &quot;jpda start&quot;   
                command is executed. Specifies whether JVM should suspend   
                execution immediately after startup. Default is &quot;n&quot;.
</code></pre><p>这里默认的jpda端口号为8000  </p>
<blockquote>
<p>E:\GIT\apache-tomcat-6.0.44\bin&gt;start “Tomcat” “D:\Program Files\Java\jdk1.8.0_51\bin\java.exe” \<br>-Djava.util.logging.config.file=”E:\GIT\apache-tomcat-6.0.44\conf\logging.properties” \<br>-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager \<br>-agentlib:jdwp=transport=dt_socket,address=8000,server=y,suspend=n  \<br>-Djava.endorsed.dirs=”E:\GIT\apache-tomcat-6.0.44\endorsed”    \<br>-classpath “E:\GIT\apache-tomcat-6.0.44\bin\bootstrap.jar”    \<br>-Dcatalina.base=”E:\GIT\apache-tomcat-6.0.44”<br>-Dcatalina.home=”E:\GIT\apache-tomcat-6.0.44”    \<br>-Djava.io.tmpdir=”E:\GIT\apache-tomcat-6.0.44\temp”  \<br>org.apache.catalina.startup.Bootstrap  start</p>
</blockquote>
<h2 id="Sun-官方文档说明"><a href="#Sun-官方文档说明" class="headerlink" title="Sun 官方文档说明"></a>Sun 官方文档说明</h2><h3 id="DESCRIPTION"><a href="#DESCRIPTION" class="headerlink" title="DESCRIPTION"></a>DESCRIPTION</h3><p>The Java Debugger, jdb, is a simple command-line debugger for Java classes. It is a demonstration of the Java Platform Debugger Architecture that provides inspection and debugging of a local or remote Java Virtual Machine.</p>
<h3 id="Starting-a-jdb-Session"><a href="#Starting-a-jdb-Session" class="headerlink" title="Starting a jdb Session"></a>Starting a jdb Session</h3><p>There are many ways to start a jdb session. The most frequently used way is to have jdb launch a new Java Virtual Machine (VM) with the main class of the application to be debugged. This is done by substituting the command jdb for java in the command line. For example, if your application’s main class is MyClass, you use the following command to debug it under JDB:</p>
<blockquote>
<p>C:> jdb MyClass </p>
</blockquote>
<p>When started this way, jdb invokes a second Java VM with any specified parameters, loads the specified class, and stops the VM before executing that class’s first instruction.</p>
<p>Another way to use jdb is by attaching it to a Java VM that is already running. A VM that is to be debugged with jdb must be started with the following options. These options load in-process debugging libraries and specify the kind of connection to be made.</p>
<blockquote>
<p>-agentlib:jdwp=transport=dt_shmem,server=y,suspend=n</p>
</blockquote>
<p>For example, the following command will run the MyClass application, and allow jdb to connect to it at a later time.</p>
<blockquote>
<p>C:> java -agentlib:jdwp=transport=dt_shmem,address=jdbconn,server=y,suspend=n MyClass</p>
</blockquote>
<p>You can then attach jdb to the VM with the following commmand:</p>
<blockquote>
<p>C:> jdb -attach jdbconn </p>
</blockquote>
<p>… </p>
<blockquote>
<p>Note that “MyClass” is not specified in the jdb command line in this case because jdb is connecting to an existing VM instead of launching a new one.</p>
</blockquote>
<p>There are many other ways to connect the debugger to a VM, and all of them are supported by jdb. The Java Platform Debugger Architecture has additional documentation on these connection options. For information on starting a J2SE 1.4.2 or early VM for use with jdb see 1.4.2 documentation</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jpda/">jpda</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-动手安装-Haskell-koans-笔记" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/201608动手安装-Haskell-koans-笔记/" class="article-date">
      <time datetime="2016-08-15T07:24:30.000Z" itemprop="datePublished">2016-08-15</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/201608动手安装-Haskell-koans-笔记/">动手安装 Haskell koans 笔记</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="下载源代码"><a href="#下载源代码" class="headerlink" title="下载源代码"></a>下载源代码</h2><h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cabal update</div><div class="line">cabal build Setup.hs -v</div></pre></td></tr></table></figure>
<h3 id="报错了"><a href="#报错了" class="headerlink" title="报错了"></a>报错了</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Package has never been configured. Configuring with default flags. If this</div><div class="line">fails, please run configure manually.</div><div class="line">/usr/local/bin/ghc --numeric-version</div><div class="line">looking for tool ghc-pkg near compiler in /usr/local/bin</div><div class="line">found ghc-pkg in /usr/local/bin/ghc-pkg</div><div class="line">/usr/local/bin/ghc-pkg --version</div><div class="line">/usr/local/bin/ghc --supported-languages</div><div class="line">/usr/local/bin/ghc --info</div><div class="line">Reading available packages...</div><div class="line">Choosing modular solver.</div><div class="line">Resolving dependencies...</div><div class="line">Could not resolve dependencies:</div><div class="line">trying: HaskellKoans-0.1 (user goal)</div><div class="line">next goal: testloop (dependency of HaskellKoans-0.1)</div><div class="line">Dependency tree exhaustively searched.</div><div class="line">Configuring HaskellKoans-0.1...</div><div class="line">cabal: At least the following dependencies are missing:</div><div class="line">HUnit -any,</div><div class="line">attoparsec -any,</div><div class="line">hspec -any,</div><div class="line">mtl -any,</div><div class="line">testloop -any,</div><div class="line">text -any</div></pre></td></tr></table></figure>
<h3 id="缺少依赖，接着安装依赖"><a href="#缺少依赖，接着安装依赖" class="headerlink" title="缺少依赖，接着安装依赖"></a>缺少依赖，接着安装依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">  cabal install HUnit</div><div class="line">Resolving dependencies...</div><div class="line">Configuring HUnit-1.3.1.1...</div><div class="line">Failed to install HUnit-1.3.1.1</div><div class="line">Build log ( /root/.cabal/logs/HUnit-1.3.1.1.log ):</div><div class="line">cabal: Error: some packages failed to install:</div><div class="line">HUnit-1.3.1.1 failed during the configure step. The exception was:</div><div class="line">user error (&apos;/usr/local/bin/ghc&apos; exited with an error:</div><div class="line">/usr/bin/ld: cannot find -lgmp</div><div class="line">collect2: ld returned 1 exit status</div><div class="line">)</div></pre></td></tr></table></figure>
<h3 id="根据提示，缺少libgmp-so"><a href="#根据提示，缺少libgmp-so" class="headerlink" title="根据提示，缺少libgmp.so"></a>根据提示，缺少libgmp.so</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">gcc -lgmp --verbose</div><div class="line">Using built-in specs.</div><div class="line">Target: x86_64-redhat-linux</div><div class="line">Configured with: ../configure --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --with-bugurl=http://bugzilla.redhat.com/bugzilla --enable-bootstrap --enable-shared --enable-threads=posix --enable-checking=release --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-languages=c,c++,objc,obj-c++,java,fortran,ada --enable-java-awt=gtk --disable-dssi --with-java-home=/usr/lib/jvm/java-1.5.0-gcj-1.5.0.0/jre --enable-libgcj-multifile --enable-java-maintainer-mode --with-ecj-jar=/usr/share/java/eclipse-ecj.jar --disable-libjava-multilib --with-ppl --with-cloog --with-tune=generic --with-arch_32=i686 --build=x86_64-redhat-linux</div><div class="line">Thread model: posix</div><div class="line">gcc version 4.4.7 20120313 (Red Hat 4.4.7-17) (GCC) </div><div class="line">COMPILER_PATH=/usr/libexec/gcc/x86_64-redhat-linux/4.4.7/:/usr/libexec/gcc/x86_64-redhat-linux/4.4.7/:/usr/libexec/gcc/x86_64-redhat-linux/:/usr/lib/gcc/x86_64-redhat-linux/4.4.7/:/usr/lib/gcc/x86_64-redhat-linux/:/usr/libexec/gcc/x86_64-redhat-linux/4.4.7/:/usr/libexec/gcc/x86_64-redhat-linux/:/usr/lib/gcc/x86_64-redhat-linux/4.4.7/:/usr/lib/gcc/x86_64-redhat-linux/</div><div class="line">LIBRARY_PATH=/usr/lib/gcc/x86_64-redhat-linux/4.4.7/:/usr/lib/gcc/x86_64-redhat-linux/4.4.7/:/usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64/:/lib/../lib64/:/usr/lib/../lib64/:/usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../:/lib/:/usr/lib/</div><div class="line">COLLECT_GCC_OPTIONS=&apos;-v&apos; &apos;-mtune=generic&apos;</div><div class="line"> /usr/libexec/gcc/x86_64-redhat-linux/4.4.7/collect2 --eh-frame-hdr --build-id -m elf_x86_64 --hash-style=gnu -dynamic-linker /lib64/ld-linux-x86-64.so.2 /usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64/crt1.o /usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64/crti.o /usr/lib/gcc/x86_64-redhat-linux/4.4.7/crtbegin.o -L/usr/lib/gcc/x86_64-redhat-linux/4.4.7 -L/usr/lib/gcc/x86_64-redhat-linux/4.4.7 -L/usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64 -L/lib/../lib64 -L/usr/lib/../lib64 -L/usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../.. -lgmp -lgcc --as-needed -lgcc_s --no-as-needed -lc -lgcc --as-needed -lgcc_s --no-as-needed /usr/lib/gcc/x86_64-redhat-linux/4.4.7/crtend.o /usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64/crtn.o</div><div class="line">/usr/bin/ld: cannot find -lgmp</div><div class="line">collect2: ld returned 1 exit status</div></pre></td></tr></table></figure>
<h3 id="试着安装一下"><a href="#试着安装一下" class="headerlink" title="试着安装一下"></a>试着安装一下</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">yum -y install gmp</div><div class="line">Failed to set locale, defaulting to C</div><div class="line">Loaded plugins: fastestmirror, security</div><div class="line">Setting up Install Process</div><div class="line">Loading mirror speeds from cached hostfile</div><div class="line"> ...</div><div class="line">base                                                                                                                  | 3.7 kB     00:00     </div><div class="line">extras                                                                                                                | 3.4 kB     00:00     </div><div class="line">nginx                                                                                                                 | 2.9 kB     00:00     </div><div class="line">updates                                                                                                               | 3.4 kB     00:00     </div><div class="line">Package gmp-4.3.1-10.el6.x86_64 already installed and latest version</div><div class="line">Nothing to do</div></pre></td></tr></table></figure>
<h3 id="貌似已经安装了"><a href="#貌似已经安装了" class="headerlink" title="貌似已经安装了"></a>貌似已经安装了</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># find / -name libgmp.so*</div><div class="line">/opt/gitlab/embedded/lib/engines/libgmp.so</div><div class="line">/usr/lib64/libgmp.so.3.5.0</div><div class="line">/usr/lib64/libgmp.so.3</div><div class="line">/usr/lib64/openssl/engines/libgmp.so</div><div class="line">/usr/lib64/libgmp.so.10</div></pre></td></tr></table></figure>
<h3 id="建立一个符号链接试试"><a href="#建立一个符号链接试试" class="headerlink" title="建立一个符号链接试试"></a>建立一个符号链接试试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ln -sv /usr/lib64/libgmp.so.3.5.0 /usr/lib64/libgmp.so</div><div class="line">`/usr/lib64/libgmp.so&apos; -&gt; `/usr/lib64/libgmp.so.3.5.0&apos;</div></pre></td></tr></table></figure>
<h3 id="在看看结果"><a href="#在看看结果" class="headerlink" title="在看看结果"></a>在看看结果</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> ls -al /usr/lib64/libgmp*</div><div class="line">lrwxrwxrwx. 1 root root     26 Aug 15 07:18 /usr/lib64/libgmp.so -&gt; /usr/lib64/libgmp.so.3.5.0</div><div class="line">lrwxrwxrwx. 1 root root     11 Jul 26 05:07 /usr/lib64/libgmp.so.10 -&gt; libgmp.so.3</div><div class="line">lrwxrwxrwx. 1 root root     15 Jun 21 01:58 /usr/lib64/libgmp.so.3 -&gt; libgmp.so.3.5.0</div><div class="line">-rwxr-xr-x. 1 root root 376792 Nov 18  2015 /usr/lib64/libgmp.so.3.5.0</div><div class="line">lrwxrwxrwx. 1 root root     17 Jun 21 01:58 /usr/lib64/libgmpxx.so.4 -&gt; libgmpxx.so.4.1.0</div><div class="line">-rwxr-xr-x. 1 root root  17992 Nov 18  2015 /usr/lib64/libgmpxx.so.4.1.0</div></pre></td></tr></table></figure>
<h3 id="ldconfig"><a href="#ldconfig" class="headerlink" title="ldconfig"></a>ldconfig</h3><h3 id="接着安装-竟然可以"><a href="#接着安装-竟然可以" class="headerlink" title="接着安装,竟然可以"></a>接着安装,竟然可以</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cabal install HUnit</div><div class="line">Resolving dependencies...</div><div class="line">Configuring HUnit-1.3.1.1...</div><div class="line">Building HUnit-1.3.1.1...</div><div class="line">Installed HUnit-1.3.1.1</div></pre></td></tr></table></figure>
<h3 id="然后-testloop-编译不过去了"><a href="#然后-testloop-编译不过去了" class="headerlink" title="然后 testloop 编译不过去了"></a>然后 testloop 编译不过去了</h3><pre><code>cabal install testloop
Resolving dependencies...
Configuring testloop-0.1.1.0...
Building testloop-0.1.1.0...
Failed to install testloop-0.1.1.0
Build log ( /root/.cabal/logs/testloop-0.1.1.0.log ):
Configuring testloop-0.1.1.0...
Building testloop-0.1.1.0...
Preprocessing library testloop-0.1.1.0...
[1 of 6] Compiling System.TestLoop.Internal.Signal ( src/System/TestLoop/Internal/Signal.hs, dist/build/System/TestLoop/Internal/Signal.o )
[2 of 6] Compiling System.TestLoop.Util ( src/System/TestLoop/Util.hs, dist/build/System/TestLoop/Util.o )
[3 of 6] Compiling System.TestLoop.Internal.Types ( src/System/TestLoop/Internal/Types.hs, dist/build/System/TestLoop/Internal/Types.o )
[4 of 6] Compiling System.TestLoop.Internal.Watcher ( src/System/TestLoop/Internal/Watcher.hs, dist/build/System/TestLoop/Internal/Watcher.o )
[5 of 6] Compiling System.TestLoop.Internal.Cabal ( src/System/TestLoop/Internal/Cabal.hs, dist/build/System/TestLoop/Internal/Cabal.o )
[6 of 6] Compiling System.TestLoop  ( src/System/TestLoop.hs, dist/build/System/TestLoop.o )

src/System/TestLoop.hs:47:23:
    Couldn&apos;t match type `FS.FilePath&apos; with `[Char]&apos;
    Expected type: FilePath
      Actual type: FS.FilePath
    In the second argument of `treeExtExists&apos;, namely
      `(FS.decodeString path)&apos;
    In a stmt of a &apos;do&apos; block:
      treeExtExists
        manager
        (FS.decodeString path)
        &quot;hs&quot;
        (reloadTestSuite moduleName modulePath paths)

src/System/TestLoop.hs:49:23:
    Couldn&apos;t match type `[Char]&apos; with `FS.FilePath&apos;
    Expected type: FilePath -&gt; IO ()
      Actual type: FS.FilePath -&gt; IO ()
    In the fourth argument of `treeExtExists&apos;, namely
      `(reloadTestSuite moduleName modulePath paths)&apos;
    In a stmt of a &apos;do&apos; block:
      treeExtExists
        manager
        (FS.decodeString path)
        &quot;hs&quot;
        (reloadTestSuite moduleName modulePath paths)
cabal: Error: some packages failed to install:
testloop-0.1.1.0 failed during the building phase. The exception was:
ExitFailure 1
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/haskell/">haskell</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/koan/">koan</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-awesome-koans" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/201608awesome-koans/" class="article-date">
      <time datetime="2016-08-12T07:56:23.000Z" itemprop="datePublished">2016-08-12</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/201608awesome-koans/">awesome koans</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="awesome-koans"><a href="#awesome-koans" class="headerlink" title="awesome-koans"></a>awesome-koans</h1><h3 id="What-is-Koan"><a href="#What-is-Koan" class="headerlink" title="What is Kōan"></a>What is <a href="https://en.wikipedia.org/wiki/K%C5%8Dan#Sources" target="_blank" rel="external">Kōan</a></h3><p>Koan（公案）是佛教禅宗的术语，乃是佛教禅宗祖师的一段言行或者一个小故事，用于引导和开悟。</p>
<p>编程语言的学习也有一种公案形式的学习方法，是我见过的最好的学习一门新的编程语言的方式。以<a href="https://en.wikipedia.org/wiki/Test-driven_development" target="_blank" rel="external">TDD</a>的形式，预先编写好每一个知识点的测试代码，引导学习者使用相关的知识编写代码以通过测试。这种像闯关一样的形式让人充满的学习的动力，也解决了很多人学习过程中只有纸上谈兵而没有动手机会的问题。</p>
<p>这个Repo用于收集各种语言可用的koans方便学习。</p>
<h3 id="AngularJS"><a href="#AngularJS" class="headerlink" title="AngularJS"></a>AngularJS</h3><p><a href="https://github.com/bjpbakker/angular-koans" target="_blank" rel="external">https://github.com/bjpbakker/angular-koans</a></p>
<h3 id="Bash"><a href="#Bash" class="headerlink" title="Bash"></a>Bash</h3><p><a href="https://github.com/marcinbunsch/bash_koans" target="_blank" rel="external">https://github.com/marcinbunsch/bash_koans</a></p>
<h3 id="Clojure"><a href="#Clojure" class="headerlink" title="Clojure"></a>Clojure</h3><p><a href="https://github.com/lazerwalker/clojurescript-koans" target="_blank" rel="external">https://github.com/lazerwalker/clojurescript-koans</a></p>
<h3 id="Cpp"><a href="#Cpp" class="headerlink" title="Cpp"></a>Cpp</h3><p><a href="https://github.com/torbjoernk/CppKoans" target="_blank" rel="external">https://github.com/torbjoernk/CppKoans</a></p>
<h3 id="ColdFusion"><a href="#ColdFusion" class="headerlink" title="ColdFusion"></a>ColdFusion</h3><p><a href="https://github.com/nodoherty/ColdFusion-Koans" target="_blank" rel="external">https://github.com/nodoherty/ColdFusion-Koans</a></p>
<h3 id="CoffeeScript"><a href="#CoffeeScript" class="headerlink" title="CoffeeScript"></a>CoffeeScript</h3><p><a href="https://github.com/sleepyfox/coffeescript-koans" target="_blank" rel="external">https://github.com/sleepyfox/coffeescript-koans</a></p>
<h3 id="CSharp"><a href="#CSharp" class="headerlink" title="CSharp"></a>CSharp</h3><p><a href="https://github.com/jtigger/csharp-koans" target="_blank" rel="external">https://github.com/jtigger/csharp-koans</a></p>
<h3 id="Dart"><a href="#Dart" class="headerlink" title="Dart"></a>Dart</h3><p><a href="https://github.com/butlermatt/dart_koans" target="_blank" rel="external">https://github.com/butlermatt/dart_koans</a></p>
<h3 id="DotNet"><a href="#DotNet" class="headerlink" title="DotNet"></a>DotNet</h3><p><a href="https://github.com/CoryFoy/DotNetKoans" target="_blank" rel="external">https://github.com/CoryFoy/DotNetKoans</a></p>
<h3 id="Elixir"><a href="#Elixir" class="headerlink" title="Elixir"></a>Elixir</h3><p><a href="https://github.com/elixirkoans/elixir-koans" target="_blank" rel="external">https://github.com/elixirkoans/elixir-koans</a></p>
<h3 id="Erlang"><a href="#Erlang" class="headerlink" title="Erlang"></a>Erlang</h3><p><a href="https://github.com/patrickgombert/erlang-koans" target="_blank" rel="external">https://github.com/patrickgombert/erlang-koans</a></p>
<h3 id="FSharp"><a href="#FSharp" class="headerlink" title="FSharp"></a>FSharp</h3><p><a href="https://github.com/ChrisMarinos/FSharpKoans" target="_blank" rel="external">https://github.com/ChrisMarinos/FSharpKoans</a></p>
<h3 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h3><p><a href="https://github.com/cdarwin/go-koans" target="_blank" rel="external">https://github.com/cdarwin/go-koans</a></p>
<h3 id="Groovy"><a href="#Groovy" class="headerlink" title="Groovy"></a>Groovy</h3><p><a href="https://github.com/nadavc/groovykoans" target="_blank" rel="external">https://github.com/nadavc/groovykoans</a></p>
<h3 id="Haskell"><a href="#Haskell" class="headerlink" title="Haskell"></a>Haskell</h3><p><a href="https://github.com/HaskVan/HaskellKoans" target="_blank" rel="external">https://github.com/HaskVan/HaskellKoans</a></p>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p><a href="https://github.com/matyb/java-koans" target="_blank" rel="external">https://github.com/matyb/java-koans</a></p>
<h3 id="Javascript"><a href="#Javascript" class="headerlink" title="Javascript"></a>Javascript</h3><p><a href="https://github.com/mrdavidlaing/javascript-koans" target="_blank" rel="external">https://github.com/mrdavidlaing/javascript-koans</a></p>
<h3 id="Kotlin"><a href="#Kotlin" class="headerlink" title="Kotlin"></a>Kotlin</h3><p><a href="https://github.com/Kotlin/kotlin-koans" target="_blank" rel="external">https://github.com/Kotlin/kotlin-koans</a></p>
<h3 id="Lisp"><a href="#Lisp" class="headerlink" title="Lisp"></a>Lisp</h3><p><a href="https://github.com/google/lisp-koans" target="_blank" rel="external">https://github.com/google/lisp-koans</a></p>
<h3 id="Lua"><a href="#Lua" class="headerlink" title="Lua"></a>Lua</h3><p><a href="https://github.com/kikito/lua_missions" target="_blank" rel="external">https://github.com/kikito/lua_missions</a></p>
<h3 id="Objective-C"><a href="#Objective-C" class="headerlink" title="Objective-C"></a>Objective-C</h3><p><a href="https://github.com/joecannatti/Objective-C-Koans" target="_blank" rel="external">https://github.com/joecannatti/Objective-C-Koans</a></p>
<h3 id="Perl"><a href="#Perl" class="headerlink" title="Perl"></a>Perl</h3><p><a href="https://github.com/forcedotcom/PerlKoans" target="_blank" rel="external">https://github.com/forcedotcom/PerlKoans</a></p>
<h3 id="Prolog"><a href="#Prolog" class="headerlink" title="Prolog"></a>Prolog</h3><p><a href="https://github.com/araneforseti/prolog-koans" target="_blank" rel="external">https://github.com/araneforseti/prolog-koans</a></p>
<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p><a href="https://github.com/gregmalcolm/python_koans" target="_blank" rel="external">https://github.com/gregmalcolm/python_koans</a></p>
<h3 id="R"><a href="#R" class="headerlink" title="R"></a>R</h3><p><a href="https://github.com/DASpringate/Rkoans" target="_blank" rel="external">https://github.com/DASpringate/Rkoans</a></p>
<h3 id="ReactJS"><a href="#ReactJS" class="headerlink" title="ReactJS"></a>ReactJS</h3><p><a href="https://github.com/arkency/reactjs_koans" target="_blank" rel="external">https://github.com/arkency/reactjs_koans</a></p>
<h3 id="Ruby"><a href="#Ruby" class="headerlink" title="Ruby"></a>Ruby</h3><p><a href="http://rubykoans.com/" target="_blank" rel="external">http://rubykoans.com/</a></p>
<h3 id="Scala"><a href="#Scala" class="headerlink" title="Scala"></a>Scala</h3><p><a href="https://github.com/rubbish/scala-koans" target="_blank" rel="external">https://github.com/rubbish/scala-koans</a></p>
<h3 id="Smalltalk"><a href="#Smalltalk" class="headerlink" title="Smalltalk"></a>Smalltalk</h3><p><a href="https://github.com/sl4m/gnu_smalltalk_koans" target="_blank" rel="external">https://github.com/sl4m/gnu_smalltalk_koans</a></p>
<h3 id="Swift"><a href="#Swift" class="headerlink" title="Swift"></a>Swift</h3><p><a href="https://github.com/mokagio/Swift-Koans" target="_blank" rel="external">https://github.com/mokagio/Swift-Koans</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/awesome/">awesome</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/koans/">koans</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-BT种子嗅探器原理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/201608BT种子嗅探器原理/" class="article-date">
      <time datetime="2016-08-12T05:00:30.000Z" itemprop="datePublished">2016-08-12</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/201608BT种子嗅探器原理/">BT种子嗅探器原理</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前看到 lantern 这个十分火的翻墙工具，其利用了P2P的思想，就想了解一下P2P相关的协议。看了下最流行的BT协议官方文档，就产生了实现BT协议的想法，顺便根据协议实现了一个BT种子嗅探器。</p>
<p>也有人将BT种子嗅探器称为BT种子爬虫，个人觉得其行为特性和传统的web爬虫相差较大，反而和嗅探器很类似，因此暂且称之为BT种子嗅探器吧。</p>
<p>接下来将写一系列文章来介绍其原理和具体实现方式。这篇文章先提纲挈领，介绍其工作原理，以对全局有一个把握。后序的文章再介绍具体细节。</p>
<h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>在讲原理之前首先你得具备BitTorrent(简称BT)协议的一些基本知识，以便于理解接下来要讲的嗅探器。BT协议其实是一个协议簇，BEP-3 是其基本协议内容，其他的大部分都是围绕这个来进行扩展或补充。要想从BT网络中下载一个资源，必须具备以下部分：</p>
<p>种子文件（也就是我们常说的种子，后缀是 .torrent，本质上是一个由bencode编码的文本文件，其把资源分成很多虚拟块，并记录每个块的hash值，另外上面还记录着其他信息，比如文件大小、名字、Tracker服务器等）<br>BT客户端（需要有专门解析BT协议的程序，这样才能下载，比如迅雷，电驴）<br>Tracker服务器 （记录着peer和种子相关信息，起着中心调控的作用）<br>下载资源的时候，客户端首先根据bencode（bencode是BT协议中的编码方式）解码种子文件，得到Tracker服务器的地址和资源信息，通过和Tracker服务器沟通得到其他已经下载该资源的peers信息（其他已经拥有该资源的客户端或者发布该资源的人），然后再和这些peers沟通得到自己想要的部分，即互通有无。由于把文件分成很多块来同时从不同的地方下载，这也就是为什么BT通常下载快的原因。</p>
<h2 id="DHT协议"><a href="#DHT协议" class="headerlink" title="DHT协议"></a>DHT协议</h2><p>通过上面我们知道，Tracker服务器在资源下载的过程中起着至关重要的作用，只有通过它我们才能得到其他peers的信息，才能够下载，但这同时也成了BT协议的一个弱点，如果Tracker服务器挂掉了或者被封被屏蔽，整个网络也就瘫痪了。由于一些资源都是有版权的，还有一些资源是限制级的，比如色情资源，Tracker服务器很容易被迫关闭或被墙。后来聪明的人类发明了另外一种协议，就是 Distributed hash table, 简称DHT，这个协议就是用来弥补这个弱点的。</p>
<p>BT协议簇中的DHT协议 是基于 Kademlia协议 建立的，其基本思想很好理解。DHT 由很多节点组成，每个节点保存一张表，表里边记录着自己的好友节点。当你向一个节点A查询另外一个节点B的信息的时候，A就会查询自己的好友表，如果里边包含B，那么A就返回B的信息，否则A就返回距离B距离最近的k个节点。然后你再向这k个节点再次查询B的信息，这样循环一直到查询到B的信息，查询到B的信息后你应该向之前所有查询过的节点发个通知，告诉他们，你有B的信息。</p>
<p>举个例子，比如我现在想要Angelababy的微信号（额…我要干嘛），我就从自己的微信好友中挑出k个最可能认识她的人，然后依次问他们有没有Angelababy的微信号，假如其中一个认识，那么他就会给我Angelababy的微信号，我也就不继续问其他人了。假如他不认识，他就给我推荐k个他微信好友中最有可能认识Angelababy的k个人，然后我再继续这k个人，就这样循环一直到我问到为止。OK，现在我已经得到了Angelababy的微信号，我就会告诉之前所有我问过的人，我有Angelababy的微信号。</p>
<p>当客户端下载资源的时候，他会利用上述方式查找peers信息，这样每个人都充当了Tracker的作用，也就解决了上面那个问题。</p>
<h2 id="嗅探器原理"><a href="#嗅探器原理" class="headerlink" title="嗅探器原理"></a>嗅探器原理</h2><p>终于到核心部分了。</p>
<p>BT种子嗅探器就是利用了DHT协议得到peer信息后会向他之前查询过的节点发送通知这一点，这就是嗅探器的核心。</p>
<p>剩下的工作就是我们要让更多的节点发给我们通知。那么如何让更多的节点发给我们通知呢？</p>
<p>我们要不断的查询自己的好友节点表，并对返回回来的节点进行查询，这样才会有更多的人认识我们<br>别人向我们查询Target的时候，我们要伪装成Target的好友，返回结果里边包括自己，这样会有更多被查询、收到通知的机会<br>这就是BT种子嗅探器的原理，简单吧 :)</p>
<h2 id="种子下载器"><a href="#种子下载器" class="headerlink" title="种子下载器"></a>种子下载器</h2><p>在BT网络中，通过上述原理收到信息并不是种子，而是发送消息者的ip和port、种子infohash（可以理解为种子的id）。我们如果想要得到种子的话，还需要做一番工作。这里涉及到另外一个非常重要的协议 BEP-09，BEP-09规定了如何通过种子infohash得到种子。</p>
<p>这里不铺开讲，仅说下大致过程。首先同我们收到的消息里边的 ip:port 建立TCP连接，然后发送握手消息，并告知对方自己支持BEP-09协议，然后向对方请求种子的信息，收到对方返回的种子信息后，依次或同时请求每一个块。最有所有块收集完后，对其进行拼接并通过sha1算法计算其infohash，如果和我们请求的infohash值相同则保存起来，否则丢掉。</p>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><p>这样你可以得到非常多的种子信息，你可以对其进行索引建立自己的BT种子搜索引擎，建立自己的海盗湾。但你需要注意版权问题和色情资源问题。</p>
<h1 id="BT种子嗅探器–DHT篇"><a href="#BT种子嗅探器–DHT篇" class="headerlink" title="BT种子嗅探器–DHT篇"></a>BT种子嗅探器–DHT篇</h1><h2 id="背景知识-1"><a href="#背景知识-1" class="headerlink" title="背景知识"></a>背景知识</h2><p>DHT全称 Distributed Hash Table，中文翻译过来就是分布式哈希表。它是一种去中心化的分布式系统，特点主要有自动去中心化，强大的容错能力，支持扩展。另外它规定了自己的架构，包括keyspace和overlay network（覆盖网络）两部分。但是他没有规定具体的算法细节，所以出现了很多不同的实现方式，比如Chord，Pastry，Kademlia等。BitTorrent中的DHT是基于Kademlia的一种变形，它的官方名称叫做 Mainline DHT。</p>
<p>DHT人如其名，把它看成一个整体，从远处看它，它就是一张哈希表，只不过这张表是分布式的，存在于很多机器上。它同时支持set(key, val)，get(key)操作。DHT可以用于很多方面，比如分布式文件系统，DNS，即时消息(IM)，以及我们最熟悉的点对点文件共享（比如BT协议）等。</p>
<p>下面我们提到的DHT默认都是Mainline DHT，例子都是用伪代码来表示。读下面段落的时候要时刻记着，DHT是一个哈希表。</p>
<blockquote>
<p>Mainline DHT<br>Mainline DHT遵循DHT的架构，下面我们分别从Keyspace和Overlay network两方面具体说明。</p>
<p>Keyspace<br>keyspace主要是关于key的一些规定。</p>
</blockquote>
<p>Mainline dht里边的key长度为160bit，注意是bit，不是byte。在常见的编译型编程语言中，最长的整型也才是64bit，所以用整型是表示不了key的，我们得想其他的方式。我们可以用数组方式表示它，数组类型你可以选用长度不同的整型，比如int8，int16，int32等。这里为了下边方便计算，我们采用长度为20的byte数组来表示。</p>
<p>在mainline dht中，key之间唯一的一种计算是xor，即异或（还记得异或的知识吧？）。我们的key是用长度为20的byte数组来表示，因此我们应该从前往后依次计算两个key的相对应的byte的异或值，最终结果得到的是另外一个长度为20的byte数组。算法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">​for i = 0; i &lt; 20; i++ &#123;</div><div class="line">​    result[i] = key1[i] ^ key2[i];</div><div class="line">​&#125;</div></pre></td></tr></table></figure>
<p>读到这里，你是不是要问xor有啥用？还记得原理篇中DHT的工作方式吗？</p>
<p>xor是为了找到好友表中离key最近的k个节点，什么样的节点最近？就是好友中每个节点和key相异或，得到的结果越小就越近。这里又衍生另外一个问题，byte数组之间怎么比较大小？很简单，从前往后，依次比较每一个byte的大小即可。</p>
<p>在Mainline DHT中，我们用160bit的key来代表每个节点和每个资源的ID，我们查找节点或者查找资源的时候实际上就是查找他们的ID。回想一下，这是不是很哈希表? :)</p>
<p>另外聪明的你可能又该问了，我们怎么样知道每个节点或者每个资源的ID是多少？在Mainline DHT中，节点的ID一般是随机生成的，而资源的ID是用sha1算法加密资源的内容后得到的。</p>
<p>OK，关于key就这么多，代码实现你可以查考这里。</p>
<h2 id="Overlay-network"><a href="#Overlay-network" class="headerlink" title="Overlay network"></a>Overlay network</h2><p>Overlay network主要是关于DHT内部节点是怎么存储数据的，不同节点之间又是怎样通信的。</p>
<p>首先我们回顾一下原理篇中DHT的工作方式:</p>
<blockquote>
<p>DHT 由很多节点组成，每个节点保存一张表，表里边记录着自己的好友节点。当你向一个节点A查询另外一个节点B的信息的时候，A就会查询自己的好友表，如果里边包含B，那么A就返回B的信息，否则A就返回距离B距离最近的k个节点。然后你再向这k个节点再次查询B的信息，这样循环一直到查询到B的信息，查询到B的信息后你应该向之前所有查询过的节点发个通知，告诉他们，你有B的信息。<br>整个DHT是一个哈希表，它把自己的数据化整为零分散在不同的节点里。OK，现在我们看下，一个节点内部是用什么样的数据结构存储数据的。</p>
</blockquote>
<p>节点内部数据存储 - Routing Table<br>用什么样的数据结构得看支持什么样的操作，还得看各种操作的频繁程度。从上面工作方式我们知道，操作主要有两个：</p>
<p>在我（注意：“我”是一个节点）的好友节点中查询离一个key最近的k个节点（在Mainline DHT中，k=8），程度为频繁<br>把一个节点保存起来，也就是插入操作，程度为频繁<br>首先看到“最近”、“k”，我们会联想到top k问题。一个很straightforward的做法是，用一个数组保存节点。这样的话，我们看下算法复杂度。top k问题用堆解决，查询复杂度为O(k + (n-k)*log(k))，当k=8时，接近于O(n)；插入操作为O(1)。注：n为一个节点的好友节点总数。</p>
<p>当n很大的时候，操作时间可能会很长。那么有没有O(log(n))的算法呢？</p>
<p>联想到上面堆的算法，你可能说，我们可以维护一个堆啊，插入和查询的时候都是O(log(n))。这种做法堆是根据堆中元素与某一个固定不变的key的距离来维护的，但是通常情况下，我们查询的key都是变化的，因此这种做法不可行。</p>
<h2 id="那还有其他O-log-n-的算法吗？"><a href="#那还有其他O-log-n-的算法吗？" class="headerlink" title="那还有其他O(log(n))的算法吗？"></a>那还有其他O(log(n))的算法吗？</h2><p>经验告诉我们，很多O(log(n))的问题都和二叉树相关，比如各种平衡二叉树，我们能不能用二叉树来解决呢？联想到每个ID都是一个160bit的值，而且我们知道key之间的距离是通过异或来计算的，并且两个key的异或结果大小和他们的共同前缀无关，我们应该想到用Trie树（或者叫前缀树）来解决。事实上，Mainline DHT协议中用的就是Trie树，但是与Trie树又稍微有所不同。在Trie树里边，插入一个key时，我们要比对key的每一个char和Trie里边路径，当不一致时，会立刻分裂成一个子树。但是在这里，当不一致时，不会立刻分裂，而是有一个长度为k的buffer（在Mainline DHT中叫bucket）。分两种情况讨论：</p>
<p>如果bucket长度小于k，那么直接插入bucket就行了。<br>如果bucket长度大于或等于k，又要分两种情况讨论：<br>第一种情况是当前的路径是该节点ID（注意不是要插入的key，是“我”自己的ID）的前缀，那么就分裂，左右子树的key分别是0和1，并且把当前bucket中的节点根据他们的当前char值分到相应的子树的bucket里边。<br>第二种情况是当前路径不是该节点ID的前缀，这种情况下，直接把这个key丢掉。<br>如果还没有理解，你可以参照Kademlia这篇论文上面的图。</p>
<p>插入的时候，复杂度为O(log(n))。查询离key最近的k个节点时，我们可以先找到当前key对应的bucket，如果bucket里边不够k个，那么我们再查找该节点前驱和后继，最后根据他们与key的距离拍一下序即可，平均复杂度也为O(log(n))。这样插入和查询都是O(log(n))。</p>
<p>代码实现你可以查考这里。</p>
<h2 id="节点之间的通信-KRPC"><a href="#节点之间的通信-KRPC" class="headerlink" title="节点之间的通信 - KRPC"></a>节点之间的通信 - KRPC</h2><p>KRPC比较简单，它是一个简单的rpc结构，其是通过UDP传送消息的，报文是由bencode编码的字典。它包含3种消息类型，request、response和error。请求又分为四种：ping，find_node, get_peers, announce_peer。</p>
<h3 id="ping-用来侦探对方是否在线"><a href="#ping-用来侦探对方是否在线" class="headerlink" title="ping 用来侦探对方是否在线"></a>ping 用来侦探对方是否在线</h3><p>find_node 用来查找某一个节点ID为Key的具体信息，信息里包括ip，port，ID<br>get_peers 用来查找某一个资源ID为Key的具体信息，信息里包含可提供下载该资源的ip:port列表<br>announce_peer 用来告诉别人自己可提供某一个资源的下载，让别人把这个消息保存起来。还记得Angelababy那个例子吗？在我得到她的微信号后，我会通知所有我之前问过的人，他们就会把我有Angelababy微信号这个信息保存起来，以后如果有人再问他们有没有Angelababy微信号的话，他们就会告诉那个人我有。BT种子嗅探器就是根据这个来得到消息的，不过得到消息后我们还需要进一步下载。<br>跳出节点，整体看DHT这个哈希表，find_node和get_peers就是我们之前说的get(key)，announce_peer就是set(ke, val)。</p>
<p>剩下的就是具体的消息格式，你可以在官方文档上看到，这里就不搬砖了。</p>
<p>实现KRPC时，需要注意的有以下几点：</p>
<p>每次收到请求或者回复你都需要根据情况更新你的Routing Table，或保存或丢掉。<br>你需要实现transaction，transaction里边要包含你的请求信息以及被请求的ip及端口，只有这样当你收到回复消息时，你才能根据消息的transaction id做出正确的处理。Mainline DHT对于如何实现transaction没有做具体规定。<br>一开始你是不在DHT网络中的，你需要别人把你介绍进去，任何一个在DHT中的人都可以。一般我们可以向 router.bittorrent.com:6881、 dht.transmissionbt.com:6881 等发送find_node请求，然后我们的DHT就可以开始工作了。<br>KRPC的实现你可以参考这里。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>DHT整体就是一张哈希表，首先我们本身是里边的一个节点，我们向别人发送krpc find_node或get_peers消息，就是在对这个哈希表执行get(key)操作。向别人发送announce_peer消息，就是在对这个哈希表执行set(key, val)操作。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bt/">bt</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dht/">dht</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-NodeBB-基于-nodejs实现的社区论坛" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/201608NodeBB-基于-nodejs实现的社区论坛/" class="article-date">
      <time datetime="2016-08-12T04:39:00.000Z" itemprop="datePublished">2016-08-12</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/201608NodeBB-基于-nodejs实现的社区论坛/">NodeBB 基于 nodejs实现的社区论坛</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="Node-js-based-forum-software-built-for-the-modern-web-http-www-nodebb-org"><a href="#Node-js-based-forum-software-built-for-the-modern-web-http-www-nodebb-org" class="headerlink" title="Node.js based forum software built for the modern web http://www.nodebb.org"></a>Node.js based forum software built for the modern web <a href="http://www.nodebb.org" target="_blank" rel="external">http://www.nodebb.org</a></h2><p><a href="https://nodebb.org" target="_blank" rel="external"><strong>NodeBB Forum Software</strong></a> is powered by Node.js and built on either a Redis or MongoDB database. It utilizes web sockets for instant interactions and real-time notifications. NodeBB has many modern features out of the box such as social network integration and streaming discussions, while still making sure to be compatible with older browsers.</p>
<p>Additional functionality is enabled through the use of third-party plugins.</p>
<ul>
<li><a href="http://www.nodebb.org/" title="NodeBB" target="_blank" rel="external">Get NodeBB</a></li>
<li><a href="http://community.nodebb.org" target="_blank" rel="external">Demo &amp; Meta Discussion</a></li>
<li><a href="http://docs.nodebb.org" target="_blank" rel="external">Documentation &amp; Installation Instructions</a></li>
<li><a href="https://www.transifex.com/projects/p/nodebb/" target="_blank" rel="external">Help translate NodeBB</a></li>
<li><a href="http://blog.nodebb.org" target="_blank" rel="external">NodeBB Blog</a></li>
<li><a href="https://kiwiirc.com/client/irc.freenode.net/nodebb" target="_blank" rel="external">Join us on IRC</a> - #nodebb on Freenode</li>
<li><a href="http://www.twitter.com/NodeBB/" title="NodeBB Twitter" target="_blank" rel="external">Follow us on Twitter</a></li>
<li><a href="http://www.facebook.com/NodeBB/" title="NodeBB Facebook" target="_blank" rel="external">Like us on Facebook</a></li>
</ul>
<h2 id="NodeBB-Dockerfile"><a href="#NodeBB-Dockerfile" class="headerlink" title="NodeBB Dockerfile"></a>NodeBB Dockerfile</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># The base image is the latest 4.x node (LTS) on jessie (debian)</div><div class="line"># -onbuild will install the node dependencies found in the project package.json</div><div class="line"># and copy its content in /usr/src/app, its WORKDIR</div><div class="line">FROM node:4-onbuild</div><div class="line"></div><div class="line">ENV NODE_ENV=production \</div><div class="line">    daemon=false \</div><div class="line">    silent=false</div><div class="line"></div><div class="line"># nodebb setup will ask you for connection information to a redis (default), mongodb then run the forum</div><div class="line"># nodebb upgrade is not included and might be desired</div><div class="line">CMD node app --setup &amp;&amp; npm start</div><div class="line"></div><div class="line"># the default port for NodeBB is exposed outside the container</div><div class="line">EXPOSE 4567</div></pre></td></tr></table></figure>
<h1 id="Example-Forum-user-nodebb"><a href="#Example-Forum-user-nodebb" class="headerlink" title="Example Forum user nodebb"></a>Example Forum user nodebb</h1><p><a href="https://uchain.org/" target="_blank" rel="external">区块链开发者社区</a><br><img src="/images/nodebb-chain.png" alt="nodebb"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/forum/">forum</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/">nodejs</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ONLYOFFICE-协同办公" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/201608ONLYOFFICE-协同办公/" class="article-date">
      <time datetime="2016-08-11T03:28:16.000Z" itemprop="datePublished">2016-08-11</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/201608ONLYOFFICE-协同办公/">ONLYOFFICE 协同办公</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="onlyOffice"><a href="#onlyOffice" class="headerlink" title="onlyOffice"></a>onlyOffice</h2><h3 id="Collaborative-system-for-managing-documents-projects-customer-relations-and-emails-in-one-place"><a href="#Collaborative-system-for-managing-documents-projects-customer-relations-and-emails-in-one-place" class="headerlink" title="Collaborative system for managing documents, projects, customer relations and emails in one place"></a>Collaborative system for managing documents, projects, customer relations and emails in one place</h3><ul>
<li>在线编辑文档</li>
<li>客户关系管理</li>
<li>邮件服务</li>
<li>文档管理</li>
<li>项目管理</li>
<li><p>ONLYOFFICE Community Server is a free open source collaborative system developed to manage documents, projects, customer relationship and email correspondence, all in one place.</p>
</li>
<li><p>Cross platform solution: Linux, Windows</p>
</li>
<li>Document management</li>
<li>Integration with Google Drive, Box, Dropbox, OneDrive, OwnCloud</li>
<li>File sharing</li>
<li>Document embedding</li>
<li>Access rights management</li>
<li>Customizable CRM</li>
<li>Web-to-lead form</li>
<li>Invoicing system</li>
<li>Project Management</li>
<li>Gantt Chart</li>
<li>Milestones, task dependencies and subtasks</li>
<li>Time tracking</li>
<li>Automated reports</li>
<li>Blogs, forums, polls, wiki</li>
<li>Calendar</li>
<li>Email Aggregator</li>
<li>People module (employee database)</li>
<li>Instant Messenger</li>
<li>Support of more than 20 languages</li>
</ul>
<h2 id="Running-Docker-Image"><a href="#Running-Docker-Image" class="headerlink" title="Running Docker Image"></a>Running Docker Image</h2><pre><code>sudo docker run -i -t -d -p 80:80 onlyoffice/communityserver
</code></pre><p>This command will install ONLYOFFICE Community Server and all the dependencies it needs.</p>
<h2 id="Configuring-Docker-Image"><a href="#Configuring-Docker-Image" class="headerlink" title="Configuring Docker Image"></a>Configuring Docker Image</h2><p>###Auto-restart</p>
<p>To make Docker auto-restart containers on reboot, please use the –restart=always in the docker run command:</p>
<pre><code>sudo docker run -i -t -d -p 80:80 --restart=always onlyoffice/communityserver
</code></pre><h3 id="Storing-Data"><a href="#Storing-Data" class="headerlink" title="Storing Data"></a>Storing Data</h3><p>All the data are stored in the specially-designated directories, <strong>data volumes</strong>, at the following location:</p>
<ul>
<li><strong>/var/log/onlyoffice</strong> for ONLYOFFICE Community Server logs</li>
<li><strong>/var/www/onlyoffice/Data</strong> for ONLYOFFICE Community Server data</li>
<li><strong>/var/lib/mysql</strong> for MySQL database data</li>
</ul>
<p>To get access to your data from outside the container, you need to mount the volumes. It can be done by specifying the ‘-v’ option in the docker run command.</p>
<pre><code>sudo docker run -i -t -d -p 80:80 \
    -v /app/onlyoffice/CommunityServer/logs:/var/log/onlyoffice  \
    -v /app/onlyoffice/CommunityServer/data:/var/www/onlyoffice/Data  \
    -v /app/onlyoffice/CommunityServer/mysql:/var/lib/mysql  onlyoffice/communityserver
</code></pre><p>Storing the data on the host machine allows you to easily update ONLYOFFICE once the new version is released without losing your data.</p>
<h3 id="Using-MySQL"><a href="#Using-MySQL" class="headerlink" title="Using MySQL"></a>Using MySQL</h3><p>ONLYOFFICE uses <strong>MySQL 5.5</strong> to store its data.</p>
<p>By default the MySQL server is started internally. But you can easily configure the image to use an external MySQL database. </p>
<p>If you have an external MySQL server installed on your machine, execute the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sudo docker run -i -t <span class="_">-d</span> -p 80:80 -p 5222:5222 -p 443:443 \</div><div class="line"><span class="_">-e</span> MYSQL_SERVER_HOST=<span class="string">"127.0.0.1"</span> \</div><div class="line"><span class="_">-e</span> MYSQL_SERVER_PORT=<span class="string">"3306"</span> \</div><div class="line"><span class="_">-e</span> MYSQL_SERVER_DB_NAME=<span class="string">"onlyoffice"</span> \</div><div class="line"><span class="_">-e</span> MYSQL_SERVER_USER=<span class="string">"usr_onlyoffice"</span> \</div><div class="line"><span class="_">-e</span> MYSQL_SERVER_PASS=<span class="string">"onlyoffice123"</span> \</div><div class="line">onlyoffice/communityserver</div></pre></td></tr></table></figure>
<h3 id="Running-ONLYOFFICE-Community-Server-on-Different-Port"><a href="#Running-ONLYOFFICE-Community-Server-on-Different-Port" class="headerlink" title="Running ONLYOFFICE Community Server on Different Port"></a>Running ONLYOFFICE Community Server on Different Port</h3><p>To change the port, use the -p command. E.g.: to make your portal accessible via port 8080 execute the following command:</p>
<pre><code>sudo docker run -i -t -d -p 8080:80 onlyoffice/communityserver
</code></pre><h3 id="Exposing-Additional-Ports"><a href="#Exposing-Additional-Ports" class="headerlink" title="Exposing Additional Ports"></a>Exposing Additional Ports</h3><p>The container ports to be exposed for <strong>incoming connections</strong> are the folloing:</p>
<ul>
<li><strong>80</strong> for plain HTTP</li>
<li><strong>443</strong> when HTTPS is enabled (see below)</li>
<li><strong>5222</strong> for XMPP-compatible instant messaging client (for ONLYOFFICE Talk correct work)</li>
</ul>
<p>You can expose ports by specifying the ‘-p’ option in the docker run command.</p>
<pre><code>sudo docker run -i -t -d -p 80:80  -p 443:443  -p 5222:5222   onlyoffice/communityserver
</code></pre><p>For <strong>outgoing connections</strong> you need to expose the following ports:</p>
<ul>
<li><strong>80</strong> for HTTP</li>
<li><strong>443</strong> for HTTPS</li>
</ul>
<p>Additional ports to be exposed for the mail client correct work:</p>
<ul>
<li><strong>25</strong> for SMTP</li>
<li><strong>465</strong> for SMTPS</li>
<li><strong>143</strong> for IMAP</li>
<li><strong>993</strong> for IMAPS</li>
<li><strong>110</strong> for POP3</li>
<li><strong>995</strong> for POP3S</li>
</ul>
<h3 id="Running-ONLYOFFICE-Community-Server-using-HTTPS"><a href="#Running-ONLYOFFICE-Community-Server-using-HTTPS" class="headerlink" title="Running ONLYOFFICE Community Server using HTTPS"></a>Running ONLYOFFICE Community Server using HTTPS</h3><pre><code>sudo docker run -i -t -d -p 80:80  -p 443:443 \
-v /app/onlyoffice/CommunityServer/data:/var/www/onlyoffice/Data  onlyoffice/communityserver
</code></pre><p>Access to the onlyoffice application can be secured using SSL so as to prevent unauthorized access. While a CA certified SSL certificate allows for verification of trust via the CA, a self signed certificates can also provide an equal level of trust verification as long as each client takes some additional steps to verify the identity of your website. Below the instructions on achieving this are provided.</p>
<p>To secure the application via SSL basically two things are needed:</p>
<ul>
<li><strong>Private key (.key)</strong></li>
<li><strong>SSL certificate (.crt)</strong></li>
</ul>
<p>So you need to create and install the following files:</p>
<pre><code>/app/onlyoffice/CommunityServer/data/certs/onlyoffice.key
/app/onlyoffice/CommunityServer/data/certs/onlyoffice.crt
</code></pre><p>When using CA certified certificates, these files are provided to you by the CA. When using self-signed certificates you need to generate these files yourself. Skip the following section if you are have CA certified SSL certificates.</p>
<h4 id="Generation-of-Self-Signed-Certificates"><a href="#Generation-of-Self-Signed-Certificates" class="headerlink" title="Generation of Self Signed Certificates"></a>Generation of Self Signed Certificates</h4><p>Generation of self-signed SSL certificates involves a simple 3 step procedure.</p>
<p><strong>STEP 1</strong>: Create the server private key</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl genrsa -out onlyoffice.key 2048</div></pre></td></tr></table></figure>
<p><strong>STEP 2</strong>: Create the certificate signing request (CSR)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl req -new -key onlyoffice.key -out onlyoffice.csr</div></pre></td></tr></table></figure>
<p><strong>STEP 3</strong>: Sign the certificate using the private key and CSR</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl x509 -req -days 365 -in onlyoffice.csr -signkey onlyoffice.key -out onlyoffice.crt</div></pre></td></tr></table></figure>
<p>You have now generated an SSL certificate that’s valid for 365 days.</p>
<h4 id="Strengthening-the-server-security"><a href="#Strengthening-the-server-security" class="headerlink" title="Strengthening the server security"></a>Strengthening the server security</h4><p>This section provides you with instructions to <a href="https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html" target="_blank" rel="external">strengthen your server security</a>.<br>To achieve this you need to generate stronger DHE parameters.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl dhparam -out dhparam.pem 2048</div></pre></td></tr></table></figure>
<h4 id="Installation-of-the-SSL-Certificates"><a href="#Installation-of-the-SSL-Certificates" class="headerlink" title="Installation of the SSL Certificates"></a>Installation of the SSL Certificates</h4><p>Out of the four files generated above, you need to install the <code>onlyoffice.key</code>, <code>onlyoffice.crt</code> and <code>dhparam.pem</code> files at the onlyoffice server. The CSR file is not needed, but do make sure you safely backup the file (in case you ever need it again).</p>
<p>The default path that the onlyoffice application is configured to look for the SSL certificates is at <code>/var/www/onlyoffice/Data/certs</code>, this can however be changed using the <code>SSL_KEY_PATH</code>, <code>SSL_CERTIFICATE_PATH</code> and <code>SSL_DHPARAM_PATH</code> configuration options.</p>
<p>The <code>/var/www/onlyoffice/Data/</code> path is the path of the data store, which means that you have to create a folder named certs inside <code>/app/onlyoffice/CommunityServer/data/</code> and copy the files into it and as a measure of security you will update the permission on the <code>onlyoffice.key</code> file to only be readable by the owner.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mkdir -p /app/onlyoffice/CommunityServer/data/certs</div><div class="line">cp onlyoffice.key /app/onlyoffice/CommunityServer/data/certs/</div><div class="line">cp onlyoffice.crt /app/onlyoffice/CommunityServer/data/certs/</div><div class="line">cp dhparam.pem /app/onlyoffice/CommunityServer/data/certs/</div><div class="line">chmod 400 /app/onlyoffice/CommunityServer/data/certs/onlyoffice.key</div></pre></td></tr></table></figure>
<p>You are now just one step away from having our application secured.</p>
<h4 id="Available-Configuration-Parameters"><a href="#Available-Configuration-Parameters" class="headerlink" title="Available Configuration Parameters"></a>Available Configuration Parameters</h4><p><em>Please refer the docker run command options for the <code>--env-file</code> flag where you can specify all required environment variables in a single file. This will save you from writing a potentially long docker run command.</em></p>
<p>Below is the complete list of parameters that can be set using environment variables.</p>
<ul>
<li><strong>ONLYOFFICE_HTTPS_HSTS_ENABLED</strong>: Advanced configuration option for turning off the HSTS configuration. Applicable only when SSL is in use. Defaults to <code>true</code>.</li>
<li><strong>ONLYOFFICE_HTTPS_HSTS_MAXAGE</strong>: Advanced configuration option for setting the HSTS max-age in the onlyoffice nginx vHost configuration. Applicable only when SSL is in use. Defaults to <code>31536000</code>.</li>
<li><strong>SSL_CERTIFICATE_PATH</strong>: The path to the SSL certificate to use. Defaults to <code>/var/www/onlyoffice/Data/certs/onlyoffice.crt</code>.</li>
<li><strong>SSL_KEY_PATH</strong>: The path to the SSL certificate’s private key. Defaults to <code>/var/www/onlyoffice/Data/certs/onlyoffice.key</code>.</li>
<li><strong>SSL_DHPARAM_PATH</strong>: The path to the Diffie-Hellman parameter. Defaults to <code>/var/www/onlyoffice/Data/certs/dhparam.pem</code>.</li>
<li><strong>SSL_VERIFY_CLIENT</strong>: Enable verification of client certificates using the <code>CA_CERTIFICATES_PATH</code> file. Defaults to <code>false</code></li>
<li><strong>MYSQL_SERVER_HOST</strong>: The IP address or the name of the host where the server is running.</li>
<li><strong>MYSQL_SERVER_PORT</strong>: The port number.</li>
<li><strong>MYSQL_SERVER_DB_NAME</strong>: The name of a MySQL database to be created on image startup.</li>
<li><strong>MYSQL_SERVER_USER</strong>: The new user name with superuser permissions for the MySQL account.</li>
<li><strong>MYSQL_SERVER_PASS</strong>: The password set for the MySQL account. </li>
</ul>
<h2 id="Installing-ONLYOFFICE-Community-Server-integrated-with-Document-and-Mail-Servers"><a href="#Installing-ONLYOFFICE-Community-Server-integrated-with-Document-and-Mail-Servers" class="headerlink" title="Installing ONLYOFFICE Community Server integrated with Document and Mail Servers"></a>Installing ONLYOFFICE Community Server integrated with Document and Mail Servers</h2><p>ONLYOFFICE Community Server is a part of ONLYOFFICE Community Edition that comprises also Document Server and Mail Server. To install them, follow these easy steps:</p>
<p><strong>STEP 1</strong>: Create the ‘onlyoffice’ network.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker network create --driver bridge onlyoffice</div></pre></td></tr></table></figure>
<p>Than launch containers on it using the ‘docker run –net onlyoffice’ option:</p>
<p><strong>STEP 1</strong>: Install ONLYOFFICE Document Server.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo docker run --net onlyoffice -i -t <span class="_">-d</span> --restart=always --name onlyoffice-document-server \</div><div class="line">true-v /app/onlyoffice/DocumentServer/data:/var/www/onlyoffice/Data \</div><div class="line">true-v /app/onlyoffice/DocumentServer/logs:/var/<span class="built_in">log</span>/onlyoffice \</div><div class="line">trueonlyoffice/documentserver</div></pre></td></tr></table></figure>
<p><strong>STEP 2</strong>: Install ONLYOFFICE Mail Server. </p>
<p>For the mail server correct work you need to specify its hostname ‘yourdomain.com’.<br>To learn more, refer to the <a href="https://github.com/ONLYOFFICE/Docker-MailServer" title="ONLYOFFICE Mail Server documentation" target="_blank" rel="external">ONLYOFFICE Mail Server documentation</a>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">sudo docker run --net onlyoffice --privileged -i -t <span class="_">-d</span> --restart=always --name onlyoffice-mail-server \</div><div class="line">true-p 25:25 -p 143:143 -p 587:587 \</div><div class="line">true-v /app/onlyoffice/MailServer/data:/var/vmail \</div><div class="line">true-v /app/onlyoffice/MailServer/data/certs:/etc/pki/tls/mailserver \</div><div class="line">true-v /app/onlyoffice/MailServer/logs:/var/<span class="built_in">log</span> \</div><div class="line">true-v /app/onlyoffice/MailServer/mysql:/var/lib/mysql \</div><div class="line">true-h yourdomain.com \</div><div class="line">trueonlyoffice/mailserver</div></pre></td></tr></table></figure>
<p><strong>STEP 3</strong>: Install ONLYOFFICE Community Server</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">sudo docker run --net onlyoffice -i -t <span class="_">-d</span> --restart=always --name onlyoffice-community-server \</div><div class="line">true-p 80:80 -p 5222:5222 -p 443:443 \</div><div class="line">true-v /app/onlyoffice/CommunityServer/data:/var/www/onlyoffice/Data \</div><div class="line">true-v /app/onlyoffice/CommunityServer/mysql:/var/lib/mysql \</div><div class="line">true-v /app/onlyoffice/CommunityServer/logs:/var/<span class="built_in">log</span>/onlyoffice \</div><div class="line">true-v /app/onlyoffice/DocumentServer/data:/var/www/onlyoffice/DocumentServerData \</div><div class="line">true<span class="_">-e</span> DOCUMENT_SERVER_PORT_80_TCP_ADDR=onlyoffice-document-server \</div><div class="line">true<span class="_">-e</span> MAIL_SERVER_DB_HOST=onlyoffice-mail-server \</div><div class="line">trueonlyoffice/communityserver</div></pre></td></tr></table></figure>
<p>Alternatively, you can use an automatic installation script to install the whole ONLYOFFICE Community Edition at once. For the mail server correct work you need to specify its hostname ‘yourdomain.com’.</p>
<p><strong>STEP 1</strong>: Download the Community Edition Docker script file</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget http://download.onlyoffice.com/install/opensource-install.sh</div></pre></td></tr></table></figure>
<p><strong>STEP 2</strong>: Install ONLYOFFICE Community Edition executing the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bash opensource-install.sh -md yourdomain.com</div></pre></td></tr></table></figure>
<p>Or, use <a href="https://docs.docker.com/compose/install" title="docker-compose" target="_blank" rel="external">docker-compose</a>. For the mail server correct work you need to specify its hostname ‘yourdomain.com’. Assuming you have docker-compose installed, execute the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget https://raw.githubusercontent.com/ONLYOFFICE/Docker-CommunityServer/master/docker-compose.yml</div><div class="line">docker-compose up <span class="_">-d</span></div></pre></td></tr></table></figure>
<h2 id="Upgrading-ONLYOFFICE-Community-Server"><a href="#Upgrading-ONLYOFFICE-Community-Server" class="headerlink" title="Upgrading ONLYOFFICE Community Server"></a>Upgrading ONLYOFFICE Community Server</h2><p>To upgrade to a newer release, please follow there easy steps:</p>
<p><strong>STEP 1</strong>: Make sure that all the container volumes are mounted following the <strong>Storing Data</strong> section instructions:</p>
<pre><code>sudo docker inspect --format=&apos;{{range $p,$conf:=.HostConfig.Binds}}{{$conf}};{{end}}&apos; {{COMMUNITY_SERVER_ID}} 
</code></pre><p>where<br>     stands for a container name or ID</p>
<p><strong>STEP 2</strong> Remove the current container<br>    sudo docker rm -f </p>
<p><strong>STEP 3</strong> Remove the current image<br>    sudo docker rmi -f $(sudo docker images | grep onlyoffice/communityserver | awk ‘{ print $3 }’)</p>
<p><strong>STEP 4</strong> Run the new image with the same map paths</p>
<pre><code>sudo docker run -i -t -d -p 80:80 \
-v /app/onlyoffice/CommunityServer/logs:/var/log/onlyoffice  \
-v /app/onlyoffice/CommunityServer/data:/var/www/onlyoffice/Data  \
-v /app/onlyoffice/CommunityServer/mysql:/var/lib/mysql  onlyoffice/communityserver
</code></pre><h2 id="Project-Information"><a href="#Project-Information" class="headerlink" title="Project Information"></a>Project Information</h2><p>Official website: <a href="http://onlyoffice.org" title="http://www.onlyoffice.org" target="_blank" rel="external">http://www.onlyoffice.org</a></p>
<p>Code repository: <a href="https://github.com/ONLYOFFICE/CommunityServer" title="https://github.com/ONLYOFFICE/CommunityServer" target="_blank" rel="external">https://github.com/ONLYOFFICE/CommunityServer</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/office/">office</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-docker-hub-国内加速" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/201608docker-hub-国内加速/" class="article-date">
      <time datetime="2016-08-10T07:40:01.000Z" itemprop="datePublished">2016-08-10</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/201608docker-hub-国内加速/">docker hub 国内加速</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="https://www.daocloud.io/mirror" target="_blank" rel="external">DaoCloud 加速器</a>是广受欢迎的 Docker 工具，解决了国内用户访问 Docker Hub 缓慢的问题。DaoCloud 加速器结合国内的 CDN 服务与协议层优化，成倍的提升了下载速度。</p>
<h1 id="配置加速器"><a href="#配置加速器" class="headerlink" title="配置加速器"></a>配置加速器</h1><p>请先确定您的 Docker 版本在 1.8 及以上。<br>登陆<a href="https://www.daocloud.io/mirror#accelerator-doc" target="_blank" rel="external">加速器页面</a>可以获取 mirror 地址。<br>配置好后，您可以像往常一样使用docker pull命令，在拉取 Docker Hub 镜像时会自动采用加速器的镜像服务。</p>
<h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><h3 id="自动配置-Docker-加速器"><a href="#自动配置-Docker-加速器" class="headerlink" title="自动配置 Docker 加速器"></a>自动配置 Docker 加速器</h3><p><em>适用于 Ubuntu14.04、Debian、CentOS6 、CentOS7</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://aa62783f.m.daocloud.io</div></pre></td></tr></table></figure>
<p>该脚本可以将 –registry-mirror 加入到你的 Docker 配置文件 /etc/default/docker 中。适用于 Ubuntu14.04、Debian、CentOS6 、CentOS7，其他版本可能有细微不同。更多详情请访问文档。</p>
<p>登陆后参考<a href="https://www.daocloud.io/mirror#accelerator-doc" target="_blank" rel="external">配置命令</a><br>此命令会帮助您配置 registry-mirror 并重启 Docker Daemon。</p>
<h3 id="手动配置-Docker-加速器"><a href="#手动配置-Docker-加速器" class="headerlink" title="手动配置 Docker 加速器"></a>手动配置 Docker 加速器</h3><p><em>适用于各种 Linux 发行版</em></p>
<p>您可以找到 Docker 配置文件，一般配置文件在<figure class="highlight plain"><figcaption><span>，在配置文件中的```DOCKER_OPTS```加入</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CentOS 7  在 /lib/systemd/system/docker.service 中</div></pre></td></tr></table></figure></p>
<p>–registry-mirror=加速地址<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">重启Docker，一般可以用下面命令重启</div></pre></td></tr></table></figure></p>
<p>service docker restart<br>```</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Telegram-一款开源简洁的IM" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/201608Telegram-一款开源简洁的IM/" class="article-date">
      <time datetime="2016-08-09T01:18:37.000Z" itemprop="datePublished">2016-08-09</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/201608Telegram-一款开源简洁的IM/">Telegram  一款开源简洁的IM</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="Telegram-的诞生"><a href="#Telegram-的诞生" class="headerlink" title="Telegram 的诞生"></a>Telegram 的诞生</h2><p>Telegram 是俄罗斯兄弟帕维尔·杜罗夫(Pavel Durov)与尼古拉·杜罗夫(Nikolai Durov)于2013年创建的，他们也是俄罗斯最大社交网站VKontakte的创始人。当VKontakte引发俄罗斯政府关注后，帕维尔逃离俄罗斯。当他与正与圣彼得堡家中与特警队对峙的兄弟尼古拉通话时，他想到了创建Telegram的主意。他说 ：“我意识到，我没有与兄弟通信的安全方式，这就是Telegram诞生的初衷。</p>
<h2 id="可能是最注重隐私的通讯应用"><a href="#可能是最注重隐私的通讯应用" class="headerlink" title="可能是最注重隐私的通讯应用"></a>可能是最注重隐私的通讯应用</h2><p>都说在互联网上的东西就枉谈隐私了，大多数人对信息安全的概念是很弱的。Telegram 官方明确表示自己的态度：大型互联网公司总是想方设法让公众相信一种观点，保护隐私就是隐藏自己的线上信息不让身边的人知道，而实际上与此同时将大量的用户个人数据以某种形式变卖。而 Telegram 要做的是切实避免这样的情况，技术上的细则可以在网页上看到相关详尽的解说。</p>
<p>当然这些响亮的名号在日常使用中并不能轻易体验到，抛开技术层面的说明不谈，光是其悬赏 30 万美元给能够黑进应用的人，且至今无人能破这一点，也值得人对其报以关注。此外，用户还可以设置在一定时间内不登陆则自动销毁账号和一切信息，不费吹灰之力斩断后顾之忧；陌生人之间可以通过搜索 Username 进行临时会话，而不必暴露电话号码，只有主动共享手机号后才会添加进通讯录。</p>
<p>比起其他应用，Telegram 的会话选项多样，除正常会话和刚才提到的陌生人临时会话以外，还有私密会话。在此会话中可以对信息设置阅后即焚计时器，自定义多少时间后销毁信息，尤其是就算对方截屏了应用也会自动提醒这事，简直和微信「对方撤回一条信息」一样温暖人心。<br><img src="/images/telegram.png" alt="telegram"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IM/">IM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/telegram/">telegram</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2017 Smile921
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a>  <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
             tags: ".article-tag a", 
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>